<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cafe24.smart_academy.academy_manage.courseandscore.mapper.CourseAndScoreMapper">
	
	<!-- 특정 검색 키워드를 입력받아 해당 키워드에 맞는 성적결과 리스트를 리턴한다. -->
	<!-- 관리자, 강사, 학생 -->
	<select id="totalGradeResultList" parameterType="map" resultType="map">
		select
			 co.course_name								AS courseName
			,(select member_name from member where mem.member_id = tea.member_id) AS teacherName
			,aro.room_number							AS roomNumber
			,aro.room_floor								AS roomFloor
			,ed.examination_name						AS examinationName
			,ed.day										AS Day
			,(select member_name from member where mem.member_id = cen.member_id) AS studentName
			,si.score_input_no							AS scoreInputNo
			,si.score_input_test_score					AS scoreInputTestScore
			,gcr.grading_criteria_rating				AS gradingCriteriaRating
			,gcr.grading_criteria_start_of_section		AS gradingCriteriaStartOfSection
			,gcr.grading_criteria_end_of_section		AS gradingCriteriaEndOfSection
		from
			 score_input					AS si
			,examination_day				AS ed
			,course_room_assignment			AS cra
			,academy_room					AS aro
			,course							AS co
			,teacher						AS tea
			,member_login					AS login
			,member							AS mem
			,course_enrollee				AS cen
			,grading_criteria				AS gcr
		where
			si.examination_day_no		= ed.examination_day_no
		and
			ed.course_assignment_no		= cra.course_assignment_no
		and
			cra.room_no					= aro.room_no
		and
			cra.course_no				= co.course_no
		and
			co.course_no				= tea.course_no
		and
			tea.member_id				= login.member_id
		and
			login.member_id				= mem.member_id
		and
			si.course_enrollee_no		= cen.course_enrollee_no
		and
			cen.member_id				= login.member_id
		and
			cen.course_no				= co.course_no
		and
			cen.course_no				= cra.course_no
		and
			si.grading_criteria_rating	= gcr.grading_criteria_rating
		<if test="gradingCriteriaRating != null and gradingCriteriaRating neq ''.toString()">
		and
			gcr.grading_criteria_rating	= #{gradingCriteriaRating}
		</if>
		
	</select>
	
	
	<!-- 관리자 : 전체 학생 수강신청 리스트 -->
	<!-- 관리자 : 학생 수강신청 상세보기 -->
	<!-- 특정 강좌에 수강신청한 학생들 리스트 -->
	<select id="courseEnrolleeOneOrList"
			parameterType="com.cafe24.smart_academy.academy_manage.course.vo.CourseRoomSearchVO"
			resultType="map">
		select
			 ce.course_enrollee_no					AS courseEnrolleeNo
			,ce.member_id							AS memberId
			,ce.course_enrollee_registered_date		AS courseEnrolleeRegisteredDate
			,mem.member_name						AS memberName
			,mem.member_birth						AS memberBirth
			,mem.member_email						AS memberEmail
			,mem.member_phone						AS memberPhone
			,sub.subject_no							AS subjectNo
			,sub.subject_name						AS subjectName
			,ce.course_no							AS courseNo
			,co.course_name							AS courseName
			,aro.room_number						AS roomNumber
			,aro.room_floor							AS roomFloor
			,pay.start_course_day					AS startCourseDay
			,pay.end_course_day						AS endCourseDay
			,par.parent_name						AS parentName
			,par.parent_phone						AS parentPhone
		from
			 course_enrollee			AS ce
			,course						AS co
			,subject					AS sub
			,course_room_assignment		AS cra
			,academy_room				AS aro
			,member_login				AS login
			,member						AS mem
			,payment_info				AS pay
			,parent						AS par
		where
			ce.course_no		= co.course_no
		and
			ce.member_id		= login.member_id
		and
			co.subject_no		= sub.subject_no
		and
			cra.course_no		= co.course_no
		and
			cra.room_no			= aro.room_no
		and
			login.member_id		= mem.member_id
		and
			login.member_id		= pay.member_id
		and
			login.member_id		= par.member_id
		and
			login.member_level	= '학생'
		<!-- 수강신청 상세보기 진입 시 실행 -->
		<if test="courseEnrolleeNo != null and courseEnrolleeNo neq ''.toString()">
		and
			ce.course_enrollee_no	= #{courseEnrolleeNo}
		</if>
		<!-- 특정 강좌에 수강신청한 학생들 목록 조회시 실행 -->
		<if test="courseNo != null and courseNo neq ''.toString()">
		and	
			co.course_no		= #{courseNo}
		</if>
		order by
			co.course_no asc, mem.member_name asc
	</select>
	
	
	<!-- 관리자 : 수강신청코드 중복확인 -->
	<select id="courseEnrolleeByCourseEnrolleeNo"
			parameterType="String"
			resultType="String">
		select
			course_enrollee_no
		from
			course_enrollee
		where
			course_enrollee_no = #{courseEnrolleeNo}
	</select>
	
	
	<!-- 관리자 : 수강신청 추가 처리 -->
	<insert id="addCourseEnrollee"
			parameterType="com.cafe24.smart_academy.academy_manage.courseandscore.vo.CourseEnrollee">
		insert into course_enrollee (
			 course_enrollee_no
			,member_id
			,course_no
			,course_enrollee_registered_date
		) values (
			 #{courseEnrolleeNo}
			,#{memberId}
			,#{courseNo}
			,curdate()
		)
	</insert>
	
	
	<!-- 관리자 : 수강신청 수정처리 -->
	<update id="updateCourseEnrollee"
			parameterType="com.cafe24.smart_academy.academy_manage.courseandscore.vo.CourseEnrollee">
		update
			course_enrollee
		<trim prefix="set" prefixOverrides=",">
			<if test="courseNo != null and courseNo neq ''.toString()">
				 course_no		= #{courseNo}
			</if>
		</trim>
		where
			course_enrollee_no	= #{courseEnrolleeNo}
	</update>
	
	
	<!-- 관리자 : 수강신청 삭제처리 -->
	<delete id="deleteCourseEnrollee" parameterType="String">
		delete from
			course_enrollee
		where
			course_enrollee_no = #{courseEnrolleeNo}
	</delete>
	
	
	
</mapper>